# 动态路由如何影响专家并行的性能？

## 面试标准答案

动态路由通过每个token独立选择专家，导致负载分布不可预测，影响专家并行性能。主要影响：1)负载不均-某些专家过载，其他空闲，GPU利用率低；2)通信不平衡-All-to-All的发送接收量在GPU间差异大；3)计算波动-batch内处理时间取决于最慢的专家；4)难以预测-无法提前优化资源分配。缓解方法包括辅助损失鼓励均匀路由、设置专家容量上限、使用确定性路由等。静态路由虽牺牲灵活性但性能更稳定。

---

## 详细讲解

### 性能波动

```python
# 动态路由结果
Expert 0: 1000 tokens  (GPU 0过载)
Expert 1: 100 tokens   (GPU 1空闲)
Expert 2: 800 tokens
Expert 3: 50 tokens    (GPU 3空闲)

# 总时间取决于最慢的
total_time = max(process_time(expert_i))
           = process_time(expert_0)

# GPU利用率
utilization = sum(tokens) / (num_gpus * max(tokens))
            = 1950 / (4 * 1000)
            = 48.75%  # 很低!
```

### 通信不平衡

```python
# All-to-All通信
GPU 0 发送: [250, 250, 250, 250]  # 均匀
GPU 0 接收: [1000, 0, 0, 0]       # 不均!

# 导致
# - 带宽浪费
# - 同步延迟
```

### 确定性vs动态

```python
# 确定性路由
expert_id = hash(token_id) % num_experts
# 优点: 可预测, 均衡
# 缺点: 质量可能差

# 学习路由(动态)
expert_id = argmax(router_network(token))
# 优点: 质量好
# 缺点: 负载不均

# 混合: 带约束的学习路由
expert_id = constrained_router(token, load_stats)
```

### 实际影响

```
Switch Transformer测试:
纯动态路由: 波动大, 利用率60-70%
+负载均衡损失: 稳定, 利用率80-85%
+容量限制: 最稳定, 利用率85-90%
```

动态路由是MoE的双刃剑，需要careful平衡。

