---
created: '2025-10-19'
last_reviewed: null
next_review: '2025-10-19'
review_count: 0
difficulty: medium
mastery_level: 0.0
tags:
- 熟悉大语言模型推理优化-技术层次
- 熟悉大语言模型推理优化-技术层次/请求路由策略有哪些（轮询、最少连接、性能感知）？.md
related_outlines: []
---
# 请求路由策略有哪些（轮询、最少连接、性能感知）？

## 面试标准答案

主要路由策略包括：1)轮询(Round Robin)按顺序分配，简单但不考虑负载；2)加权轮询根据GPU性能分配不同权重；3)最少连接(Least Connections)选择当前活跃请求最少的副本；4)最短响应时间(Least Response Time)选择历史平均延迟最低的副本；5)哈希路由根据用户ID等特征保证会话亲和性；6)随机路由适合同构环境；7)最少队列(Least Queue)考虑等待队列长度。实际系统常用加权最少连接或响应时间感知策略，配合健康检查和动态权重调整。

---

## 详细讲解

### 主要策略对比

| 策略         | 优点         | 缺点             | 适用场景          |
| ------------ | ------------ | ---------------- | ----------------- |
| **轮询**     | 简单、公平   | 不考虑负载       | 同构GPU、均匀请求 |
| **加权轮询** | 考虑性能差异 | 静态权重         | 异构GPU           |
| **最少连接** | 动态负载均衡 | 未考虑请求复杂度 | 请求时长相似      |
| **响应时间** | 自适应性能   | 冷启动问题       | 性能波动大        |
| **哈希路由** | 会话保持     | 负载可能不均     | 需要状态保持      |
| **最少队列** | 考虑等待     | 需要队列监控     | 有缓冲队列        |

### 实现示例

```python
# 1. 轮询
def round_robin(counter, n):
    return counter % n

# 2. 加权轮询  
def weighted_round_robin(weights):
    return random.choices(range(len(weights)), weights=weights)[0]

# 3. 最少连接
def least_connections(active_counts):
    return active_counts.index(min(active_counts))

# 4. 响应时间感知
def least_response_time(avg_times):
    return min(range(len(avg_times)), key=lambda i: avg_times[i])

# 5. 哈希路由
def hash_routing(user_id, n):
    return hash(user_id) % n
```

### 混合策略

```python
class HybridRouter:
    def route(self, request):
        # 1. 过滤不健康副本
        healthy = [i for i, h in enumerate(self.health) if h]
        
        # 2. 如果需要会话保持
        if request.session_id:
            return hash(request.session_id) % len(healthy)
        
        # 3. 否则用最少连接
        return min(healthy, key=lambda i: self.connections[i])
```

### 性能对比

```
测试环境: 4副本, 混合负载

轮询: 平均延迟 250ms, P99 450ms
最少连接: 平均延迟 180ms, P99 320ms ✓
响应时间: 平均延迟 170ms, P99 300ms ✓✓
```

### 最佳实践

- 同构环境: 最少连接
- 异构环境: 加权 + 响应时间
- 需会话保持: 哈希 + 最少连接备用
- 高可用: 健康检查 + 自动故障转移


---

## 相关笔记
<!-- 自动生成 -->

- [多个模型副本如何分配请求？](notes/熟悉大语言模型推理优化-技术层次/多个模型副本如何分配请求？.md) - 相似度: 39% | 标签: 熟悉大语言模型推理优化-技术层次, 熟悉大语言模型推理优化-技术层次/多个模型副本如何分配请求？.md

