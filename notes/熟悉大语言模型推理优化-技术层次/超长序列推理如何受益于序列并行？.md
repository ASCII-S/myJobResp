# 超长序列推理如何受益于序列并行？

## 面试标准答案

超长序列推理中，序列并行的主要收益是激活显存优化。序列长度S从4096增至32768时，LayerNorm等操作的激活显存呈线性增长。8-way序列并行可将这部分显存降至1/8，使得原本显存不足的超长序列推理成为可能。例如100K token序列，标准方式需200GB激活显存，序列并行降至25GB。虽然增加通信，但NVLink带宽足够，整体使能了原本不可行的超长上下文推理。

---

## 详细讲解

### 显存瓶颈

```python
# 标准方式
S = 100000  # 100K tokens
LayerNorm激活: [32, 100000, 12288] × 2 bytes
               = 78 GB × 96层 (激活累积)
               超出显存!

# 序列并行(8-way)  
每GPU: [32, 12500, 12288] × 2 bytes
     = 9.8 GB × 96层
     可行!
```

### Ring Attention结合

```python
# Ring Attention + 序列并行
每个GPU:
1. 持有序列的一个分片
2. Ring方式计算attention
3. LayerNorm在分片上独立

优势:
- 支持无限长序列
- 显存O(S/N)而非O(S)
```

### 实际案例

```
场景: 100K token上下文推理
模型: LLaMA-70B

标准: OOM (显存不足)
序列并行(8-way): 成功，延迟+15%
```

超长序列是序列并行最有价值的应用场景。

